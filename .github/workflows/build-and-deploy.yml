name: build and deploy

on:
  push:
    branches: [ develop ]

jobs:
  deploy:
    timeout-minutes: 30
    runs-on: self-hosted
    strategy:
      matrix:
        node-version: [16.x]
    steps:
      - name: Checkout
          uses: actions/checkout@master

            - name: Get yarn cache
              id: yarn-cache
              run: echo "::set-output name=dir::$(yarn cache dir)"

            - uses: actions/cache@v1
              with:
                path: ${{ steps.yarn-cache.outputs.dir }}
                key: ${{ runner.os }}-yarn-${{ hashFiles('**/yarn.lock') }}
                restore-keys: |
                  ${{ runner.os }}-yarn-

            - name: Set up Node
              uses: actions/setup-node@v1.1.0
              with:
                node-version: '10.x'

            - name: Install dependencies
              run: yarn install --frozen-lockfile --network-timeout 1000000

            - name: stop pm2 all
              run: ./node_modules/pm2/bin/pm2 stop all
            - name: build
                run: yarn build
            - name: stop pm2 all
              run: ./node_modules/pm2/bin/pm2 start all

